name: Release

on:
  workflow_dispatch:

jobs:

#  verify:
#    uses: ./.github/workflows/verify.yml

  publish-cargo-crates:
    runs-on: ubuntu-latest
#    needs: verify
    steps:
      - uses: actions/checkout@v4
#      - uses: dtolnay/rust-toolchain@stable
#      - uses: swatinem/rust-cache@v2
#      - run: cargo install cargo-release
#      - run: cargo release --no-confirm -x patch
      - id: version
        run: |
          VERSION=$(awk -F ' = ' '$1 ~ /version/ { gsub(/[\"]/, "", $2); printf("%s",$2) }' l3_cli/Cargo.toml)
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
    outputs:
      version: ${{ steps.version.outputs.version }}

  create-gh-release:
    runs-on: ubuntu-22.04
    needs: publish-cargo-crates
    steps:
      - uses: actions/checkout@v4
      - name: Create release
        id: create
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          VERSION: ${{ needs.publish-cargo-crates.outputs.version }}
        run: |
          NOTES=$(cat l3_cli/CHANGELOG.md | awk -v p="## $VERSION" -F":" '$0 ~ p{f=1;next} /## /{f=0} f')
          CREATED_RELEASE=$(gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /repos/eighty4/l3/releases \
            -f tag_name="$VERSION" \
            -f name="$VERSION" \
            -f body="$VERSION release notes\n\n$NOTES" \
            -F draft=false \
            -F prerelease=false \
            -F generate_release_notes=false)
          echo "release_id=$(echo $CREATED_RELEASE | jq '.id')" >> "$GITHUB_OUTPUT"
          echo "upload_hostname=$(echo $CREATED_RELEASE | jq '.upload_url' | cut -d'/' -f3)" >> "$GITHUB_OUTPUT"
    outputs:
      release_id: ${{ steps.create.outputs.release_id }}
      upload_hostname: ${{ steps.create.outputs.upload_hostname }}

  upload-gh-asset-l3-linux-x86_64:
    needs: create-gh-release
    uses: ./.github/workflows/upload.yml
    with:
      filename: l3-linux-x86_64
      target: x86_64-unknown-linux-gnu
      release_id: ${{ needs.create-gh-release.outputs.release_id }}
      upload_hostname: ${{ needs.create-gh-release.outputs.upload_hostname }}
    secrets: inherit

  upload-gh-asset-l3-linux-aarch64:
    needs: create-gh-release
    uses: ./.github/workflows/upload.yml
    with:
      filename: l3-linux-aarch64
      target: aarch64-unknown-linux-gnu
      release_id: ${{ needs.create-gh-release.outputs.release_id }}
      upload_hostname: ${{ needs.create-gh-release.outputs.upload_hostname }}
    secrets: inherit

  upload-gh-asset-l3-macos-x86_64:
    needs: create-gh-release
    uses: ./.github/workflows/upload.yml
    with:
      filename: l3-macos-x86_64
      target: x86_64-apple-darwin
      release_id: ${{ needs.create-gh-release.outputs.release_id }}
      upload_hostname: ${{ needs.create-gh-release.outputs.upload_hostname }}
    secrets: inherit

  upload-gh-asset-l3-macos-aarch64:
    needs: create-gh-release
    uses: ./.github/workflows/upload.yml
    with:
      filename: l3-macos-aarch64
      target: aarch64-apple-darwin
      release_id: ${{ needs.create-gh-release.outputs.release_id }}
      upload_hostname: ${{ needs.create-gh-release.outputs.upload_hostname }}
    secrets: inherit
